from ultralytics import YOLO
import easyocr
import cv2
import requests 
import re
import difflib
import time
import sys
import serial

# ===============================
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API
# ===============================
API_URL = "https://script.google.com/macros/s/AKfycbxmk2_qFnZiYPOsRIcWvvPNN3TYeyS7lmOukSo9na_LWTFEr2Q2Gzz4zdsRCHbtz2ac/exec" 
API_KEY = "ASHI_CREAM" 

# ===============================
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Arduino (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô)
# ===============================
arduino = None
try:
    # ‡πÄ‡∏ä‡πá‡∏Ñ Port ‡∏Ç‡∏≠‡∏á Arduino ‡πÉ‡∏´‡πâ‡∏î‡∏µ‡∏ô‡∏∞‡∏Ñ‡∏£‡∏±‡∏ö (‡πÄ‡∏ä‡πà‡∏ô COM3, COM4)
    arduino = serial.Serial(port='COM5', baudrate=9600, timeout=.1)
    time.sleep(2) # ‡∏£‡∏≠ Arduino ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß
    print("‚úÖ ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Arduino ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
except Exception as e:
    print(f"‚ö†Ô∏è ‡πÑ‡∏°‡πà‡∏û‡∏ö Arduino (‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏°‡πâ‡∏Å‡∏±‡πâ‡∏ô): {e}")

# ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πâ‡∏Å‡∏±‡πâ‡∏ô
def open_gate_command():
    if arduino:
        try:
            arduino.write(bytes('0', 'utf-8'))
            print("üöß ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πâ‡∏Å‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ (Sent '0')")
        except:
            print("‚ùå ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÑ‡∏õ Arduino ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
    else:
        print("‚ö†Ô∏è ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Arduino ‡πÑ‡∏ß‡πâ")

# ===============================
# ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏£‡∏∞‡∏ö‡∏ö
# ===============================
COOLDOWN_SECONDS = 15  # ‡∏´‡πâ‡∏≤‡∏°‡∏™‡πà‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏î‡∏¥‡∏°‡∏ã‡πâ‡∏≥‡∏†‡∏≤‡∏¢‡πÉ‡∏ô 15 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
sent_plates = {}       # ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á

# ===============================
# ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î
# ===============================
THAI_PROVINCES = [
    "‡∏Å‡∏£‡∏∏‡∏á‡πÄ‡∏ó‡∏û‡∏°‡∏´‡∏≤‡∏ô‡∏Ñ‡∏£", "‡∏Å‡∏£‡∏∞‡∏ö‡∏µ‡πà", "‡∏Å‡∏≤‡∏ç‡∏à‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏Å‡∏≤‡∏¨‡∏™‡∏¥‡∏ô‡∏ò‡∏∏‡πå", "‡∏Å‡∏≥‡πÅ‡∏û‡∏á‡πÄ‡∏û‡∏ä‡∏£", "‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô", "‡∏à‡∏±‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏â‡∏∞‡πÄ‡∏ä‡∏¥‡∏á‡πÄ‡∏ó‡∏£‡∏≤", "‡∏ä‡∏•‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ä‡∏±‡∏¢‡∏ô‡∏≤‡∏ó",
    "‡∏ä‡∏±‡∏¢‡∏†‡∏π‡∏°‡∏¥", "‡∏ä‡∏∏‡∏°‡∏û‡∏£", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡∏£‡∏≤‡∏¢", "‡πÄ‡∏ä‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà", "‡∏ï‡∏£‡∏±‡∏á", "‡∏ï‡∏£‡∏≤‡∏î", "‡∏ï‡∏≤‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏ô‡∏≤‡∏¢‡∏Å", "‡∏ô‡∏Ñ‡∏£‡∏õ‡∏ê‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏û‡∏ô‡∏°", "‡∏ô‡∏Ñ‡∏£‡∏£‡∏≤‡∏ä‡∏™‡∏µ‡∏°‡∏≤",
    "‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏ò‡∏£‡∏£‡∏°‡∏£‡∏≤‡∏ä", "‡∏ô‡∏Ñ‡∏£‡∏™‡∏ß‡∏£‡∏£‡∏Ñ‡πå", "‡∏ô‡∏ô‡∏ó‡∏ö‡∏∏‡∏£‡∏µ", "‡∏ô‡∏£‡∏≤‡∏ò‡∏¥‡∏ß‡∏≤‡∏™", "‡∏ô‡πà‡∏≤‡∏ô", "‡∏ö‡∏∂‡∏á‡∏Å‡∏≤‡∏¨", "‡∏ö‡∏∏‡∏£‡∏µ‡∏£‡∏±‡∏°‡∏¢‡πå", "‡∏õ‡∏ó‡∏∏‡∏°‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏õ‡∏£‡∏∞‡∏à‡∏ß‡∏ö‡∏Ñ‡∏µ‡∏£‡∏µ‡∏Ç‡∏±‡∏ô‡∏ò‡πå",
    "‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ", "‡∏õ‡∏±‡∏ï‡∏ï‡∏≤‡∏ô‡∏µ", "‡∏û‡∏£‡∏∞‡∏ô‡∏Ñ‡∏£‡∏®‡∏£‡∏µ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤", "‡∏û‡∏∞‡πÄ‡∏¢‡∏≤", "‡∏û‡∏±‡∏á‡∏á‡∏≤", "‡∏û‡∏±‡∏ó‡∏•‡∏∏‡∏á", "‡∏û‡∏¥‡∏à‡∏¥‡∏ï‡∏£", "‡∏û‡∏¥‡∏©‡∏ì‡∏∏‡πÇ‡∏•‡∏Å", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏∏‡∏£‡∏µ", "‡πÄ‡∏û‡∏ä‡∏£‡∏ö‡∏π‡∏£‡∏ì‡πå",
    "‡πÅ‡∏û‡∏£‡πà", "‡∏†‡∏π‡πÄ‡∏Å‡πá‡∏ï", "‡∏°‡∏´‡∏≤‡∏™‡∏≤‡∏£‡∏Ñ‡∏≤‡∏°", "‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£", "‡πÅ‡∏°‡πà‡∏Æ‡πà‡∏≠‡∏á‡∏™‡∏≠‡∏ô", "‡∏¢‡πÇ‡∏™‡∏ò‡∏£", "‡∏¢‡∏∞‡∏•‡∏≤", "‡∏£‡πâ‡∏≠‡∏¢‡πÄ‡∏≠‡πá‡∏î", "‡∏£‡∏∞‡∏ô‡∏≠‡∏á", "‡∏£‡∏∞‡∏¢‡∏≠‡∏á", "‡∏£‡∏≤‡∏ä‡∏ö‡∏∏‡∏£‡∏µ",
    "‡∏•‡∏û‡∏ö‡∏∏‡∏£‡∏µ", "‡∏•‡∏≥‡∏õ‡∏≤‡∏á", "‡∏•‡∏≥‡∏û‡∏π‡∏ô", "‡πÄ‡∏•‡∏¢", "‡∏®‡∏£‡∏µ‡∏™‡∏∞‡πÄ‡∏Å‡∏©", "‡∏™‡∏Å‡∏•‡∏ô‡∏Ñ‡∏£", "‡∏™‡∏á‡∏Ç‡∏•‡∏≤", "‡∏™‡∏ï‡∏π‡∏•", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°", "‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏™‡∏≤‡∏Ñ‡∏£",
    "‡∏™‡∏£‡∏∞‡πÅ‡∏Å‡πâ‡∏ß", "‡∏™‡∏£‡∏∞‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏¥‡∏á‡∏´‡πå‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡πÇ‡∏Ç‡∏ó‡∏±‡∏¢", "‡∏™‡∏∏‡∏û‡∏£‡∏£‡∏ì‡∏ö‡∏∏‡∏£‡∏µ", "‡∏™‡∏∏‡∏£‡∏≤‡∏©‡∏é‡∏£‡πå‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏™‡∏∏‡∏£‡∏¥‡∏ô‡∏ó‡∏£‡πå", "‡∏´‡∏ô‡∏≠‡∏á‡∏Ñ‡∏≤‡∏¢", "‡∏´‡∏ô‡∏≠‡∏á‡∏ö‡∏±‡∏ß‡∏•‡∏≥‡∏†‡∏π",
    "‡∏≠‡πà‡∏≤‡∏á‡∏ó‡∏≠‡∏á", "‡∏≠‡∏≥‡∏ô‡∏≤‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç", "‡∏≠‡∏∏‡∏î‡∏£‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ï‡∏£‡∏î‡∏¥‡∏ï‡∏ñ‡πå", "‡∏≠‡∏∏‡∏ó‡∏±‡∏¢‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏≠‡∏∏‡∏ö‡∏•‡∏£‡∏≤‡∏ä‡∏ò‡∏≤‡∏ô‡∏µ", "‡∏¢‡∏∞‡∏•‡∏≤", "‡πÄ‡∏ö‡∏ï‡∏á"
]

def correct_province_name(ocr_text):
    if not ocr_text or len(ocr_text) < 2: return "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"
    matches = difflib.get_close_matches(ocr_text, THAI_PROVINCES, n=1, cutoff=0.4)
    if matches: return matches[0]
    return ocr_text

def send_to_dashboard(plate_number, province):
    
    print(f"üöÄ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {plate_number} | {province} ...")
    
    try:
        response = requests.get(API_URL, params={
            "action": "check",
            "license": plate_number, 
            "province": province, 
            "key": API_KEY
        }, timeout=5)
        
        if response.status_code == 200:
            data = response.json()
            
            # üî• [‡∏à‡∏∏‡∏î‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç] ‡∏õ‡∏£‡∏¥‡πâ‡∏ô‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏î‡∏π‡πÄ‡∏•‡∏¢‡∏ß‡πà‡∏≤ Server ‡∏ï‡∏≠‡∏ö‡∏≠‡∏∞‡πÑ‡∏£‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            print(f"üîç DEBUG ‡∏à‡∏≤‡∏Å Server: {data}") 

            # ‚úÖ [‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÉ‡∏´‡∏°‡πà] ‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö JSON ‡∏ó‡∏µ‡πà Server ‡∏™‡πà‡∏á‡∏°‡∏≤
            result = str(data.get('result', 'Unknown')).strip().lower()
            owner = str(data.get('owner', '-'))
            
            # ============================================================
            # ‚úÖ ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç‡πÉ‡∏´‡πâ‡∏â‡∏•‡∏≤‡∏î‡∏Ç‡∏∂‡πâ‡∏ô (‡∏ú‡πà‡∏≤‡∏ô‡∏á‡πà‡∏≤‡∏¢‡∏Ç‡∏∂‡πâ‡∏ô)
            # ============================================================
            # ‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç: ‡∏ñ‡πâ‡∏≤ (Access ‡πÄ‡∏õ‡πá‡∏ô allow) ‡∏´‡∏£‡∏∑‡∏≠ (‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤) => ‡πÉ‡∏´‡πâ‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏°‡∏î
            if result == "allow" or (owner != "-" and owner != ""):
                print(f"‚úÖ ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï (Allow) | ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: {owner}")
                open_gate_command() # ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πâ‡∏Å‡∏±‡πâ‡∏ô
            else:
                print(f"‚õî ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò (Deny) | ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ: {result} | ‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á: {owner}")
                
            return True
        else:
            print(f"‚ùå Server Error: {response.status_code}")
            return False
    except Exception as e:
        print(f"‚ö†Ô∏è Net Error: {e}")
        return False
    

# ===============================
# ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠)
# ===============================
print("--- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏°‡πÄ‡∏î‡∏•... ---")
model = YOLO("license_plate.pt")
reader = easyocr.Reader(['th', 'en'], gpu=False)

cap = cv2.VideoCapture(1)

print("--- üü¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡πâ‡∏ß (‡∏Å‡∏î Ctrl+C ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏´‡∏¢‡∏∏‡∏î) ---")
print("--- ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏£‡∏≠‡∏£‡∏ñ‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏•‡πâ‡∏≠‡∏á... ---")

try:
    while True:
        success, img = cap.read()
        if not success:
            print("‚ùå ‡∏≠‡πà‡∏≤‡∏ô‡∏Å‡∏•‡πâ‡∏≠‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ")
            time.sleep(1)
            continue

        # 1) YOLO Detect
        results = model(img, verbose=False)

        for r in results:
            for box in r.boxes:
                cls_id = int(box.cls[0])
                if model.names[cls_id] != "license_plate": continue

                x1, y1, x2, y2 = map(int, box.xyxy[0])
                h, w, _ = img.shape
                x1, y1 = max(0, x1), max(0, y1)
                x2, y2 = min(w, x2), min(h, y2)

                plate_img = img[y1:y2, x1:x2]
                if plate_img.size == 0: continue

                # 2) OCR Process
                try:
                    texts = reader.readtext(plate_img)
                    cat_part = ""; num_part = ""; province_part = ""

                    for t in texts:
                        txt = re.sub(r'[^\w\s]', '', t[1].strip())
                        if txt == "": continue

                        if re.match(r"^\d{1,4}$", txt):
                            if len(txt) > len(num_part): num_part = txt
                        elif re.match(r"^[‡∏Å-‡πô\s]+$", txt) and len(txt) >= 2:
                            is_known = any(p in txt for p in THAI_PROVINCES)
                            if len(txt) > 3 or "‡∏Å‡∏£‡∏∏‡∏á" in txt or "‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" in txt or is_known:
                                province_part += txt
                        elif re.search(r"[‡∏Å-‡∏Æ]", txt):
                            cat_part += txt

                    if num_part == "" and cat_part != "":
                        m = re.match(r"([0-9]*[‡∏Å-‡∏Æ]+[0-9]*)\s*([0-9]+)", cat_part)
                        if m: cat_part, num_part = m.group(1), m.group(2)

                    plate_num = f"{cat_part} {num_part}".strip()
                    province = correct_province_name(province_part.strip())

                    # 3) Check & Send
                    if num_part != "":
                        check_key = plate_num 
                        current_time = time.time()
                        last_sent_time = sent_plates.get(check_key, 0)

                        if current_time - last_sent_time > COOLDOWN_SECONDS:
                            print(f"\nüì∑ ‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏à‡∏≠: {plate_num} | {province}")
                            send_to_dashboard(plate_num, province)
                            sent_plates[check_key] = current_time
                            
                except Exception:
                    pass

except KeyboardInterrupt:
    # ‡∏î‡∏±‡∏Å‡∏à‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏î Ctrl+C ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏¥‡∏î‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏™‡∏ß‡∏¢‡πÜ
    print("\n--- üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---")
    cap.release()
    sys.exit()




#‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏õ‡∏¥‡∏î‡πÑ‡∏°‡πâ‡∏Å‡∏±‡πâ‡∏ô‡∏™‡∏≥‡∏£‡∏≠‡∏á
#except KeyboardInterrupt:
    #print("\n--- üõë ‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ---")
    #if arduino:
        #arduino.close()
    #cap.release()
    #sys.exit()